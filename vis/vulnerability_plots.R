library(ggpubr)
library(ggplot2)
library(tidyverse)
library(ggtext)

suppressMessages(library(tidyverse))
folder <- dirname(rstudioapi::getSourceEditorContext()$path)
data <- read.csv(file.path(folder, '..', 'data', 'global_results', "population_population_results.csv"))

#####################################################
##Global Population Vulnerable to Riverine Flooding##
#####################################################

df = data %>%
  group_by(continent, scenario, period) %>%
  summarize(mean = sum(value_1),
            sd = sd(value_1))

df$period = factor(
  df$period,
  levels = c('rp00100', 'rp01000'),
  labels = c('0.1%', '0.01%')
)
df$scenario = factor(
  df$scenario,
  levels = c('historical', 'rcp4p5', 'rcp8p5'),
  labels = c(
    'Historical (Baseline Condition)',
    'RCP4.5 (2050 Baseline Condition)',
    'RCP8.5 (2080 Baseline Condition)'
  )
)

max_y_value = max(df$mean)

flood_population <-
  ggplot(df,  aes(x = period, y = mean, fill = continent)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  geom_errorbar(
    data = df,
    aes(
      y = mean,
      ymin = mean - (sd/0.3),
      ymax = mean + (sd/0.3)
    ),
    position = position_dodge(1),
    lwd = 0.2,
    show.legend = FALSE,
    width = 0.5,
    color = "red"
  ) +
  geom_text(
    aes(label = format(round(after_stat(
      y
    ), 0), scientific = FALSE)),
    size = 1.8,
    position = position_dodge(1),
    vjust = .6,
    hjust = -.43,
    angle = 90
  ) +
  labs(
    colour = NULL,
    title = "Estimated Riverine Flooding Impact to Global Population",
    subtitle = "Reported by Climate Scenario, Annual Probability and Continents.",
    x = 'Annual Probability',
    y = "Population",
    fill = NULL
  ) +
  theme(
    legend.position = 'bottom',
    axis.text.x = element_text(hjust = 1, size = 8),
    panel.spacing = unit(0.6, "lines"),
    axis.text.y = element_text(size = 8),
    axis.title.y = element_text(size = 8),
    axis.title.x = element_text(size = 8)
  ) +
  expand_limits(y = 0) +
  guides(fill = guide_legend(ncol = 5, title = 'Continents')) +
  scale_fill_viridis_d(direction = 1) +
  scale_x_discrete(expand = c(0, 0.15)) +
  scale_y_continuous(
    expand = c(0, 0),
    labels = function(y)
      format(y, scientific = FALSE),
    limits = c(0, 57000)
  ) +
  facet_wrap( ~ scenario)


#################################################
##Estimated Global Area Under Riverine Flooding##
#################################################
data <- read.csv(file.path(folder, '..', 'data', 'global_results', 'area_area_results.csv'))

df = data %>%
  group_by(continent, scenario, period) %>%
  summarize(mean = mean(area)/1e6,
            sd = sd(area))

df$period = factor(
  df$period,
  levels = c('rp00100', 'rp01000'),
  labels = c('0.1%', '0.01%')
)
df$scenario = factor(
  df$scenario,
  levels = c('historical', 'rcp4p5', 'rcp8p5'),
  labels = c(
    'Historical (Baseline Condition)',
    'RCP4.5 (2050 Baseline Condition)',
    'RCP8.5 (2080 Baseline Condition)'
  )
)

max_y_value = max(df$mean)

flood_area <-
  ggplot(df,  aes(x = period, y = mean, fill = continent)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  geom_errorbar(
    data = df,
    aes(
      y = mean,
      ymin = mean - (sd/1e6),
      ymax = mean + (sd/1e6)
    ),
    position = position_dodge(1),
    lwd = 0.2,
    show.legend = FALSE,
    width = 0.5,
    color = "red"
  ) +
  geom_text(
    aes(label = format(round(after_stat(
      y
    ), 3), scientific = FALSE)),
    size = 1.8,
    position = position_dodge(1),
    vjust = .5,
    hjust = - 1.8,
    angle = 90
  ) +
  labs(
    colour = NULL,
    title = "Estimated Global Area Under Riverine Flooding",
    subtitle = "Reported by Climate Scenario, Annual Probability and Continents.",
    x = 'Annual Probability',
    y = "Population",
    fill = NULL
  ) +  ylab("Flooded Area (Millions km<sup>2)") + 
  theme(
    legend.position = 'bottom',
    axis.text.x = element_text(hjust = 1, size = 8),
    panel.spacing = unit(0.6, "lines"),
    axis.text.y = element_text(size = 8),
    axis.title.x = element_text(size = 8),
    axis.title.y = element_markdown(size = 8)
  ) +
  expand_limits(y = 0) +
  guides(fill = guide_legend(ncol = 5, title = 'Continents')) +
  scale_fill_viridis_d(direction = 1) +
  scale_x_discrete(expand = c(0, 0.15)) +
  scale_y_continuous(
    expand = c(0, 0),
    labels = function(y)
      format(y, scientific = FALSE),
    limits = c(0, 0.53)
  ) +
  facet_wrap( ~ scenario)

##############
##Panel plot##
##############

global_flooding <-
  ggarrange(
    flood_area,
    flood_population,
    nrow = 2,
    ncol = 1,
    labels = c("A", "B")
  )

path = file.path(folder, 'figures', 'global_flooding.png')
dir.create(file.path(folder, 'figures'), showWarnings = FALSE)
png(
  path,
  units = "in",
  width = 7,
  height = 7.5,
  res = 480
)
print(global_flooding)
dev.off()


