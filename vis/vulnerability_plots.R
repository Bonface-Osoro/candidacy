library(ggpubr)
library(ggplot2)
library(tidyverse)
library(ggtext)
library(readr)

suppressMessages(library(tidyverse))
folder <- dirname(rstudioapi::getSourceEditorContext()$path)
data <- read.csv(file.path(folder, '..', 'data', 'global_results', 'unconnected_global_results.csv'))

country_info = read_csv(file.path(folder, '..', 'data','raw', 'countries.csv'))
data = merge(data, country_info, by = 'iso3')


##############################################
##Global Unconnected people by income groups##
##############################################

df = data %>%
  group_by(technology, income_group) %>%
  summarize(connected_pop = sum(value),
            total_pop = sum(population))

df$unconnected_pop = (df$total_pop - df$connected_pop) 

df$technology = factor(
  df$technology,
  levels = c('GSM', '3G', '4G'),
  labels = c('GSM', '3G', '4G')
)

df$income_group = factor(
  df$income_group,
  levels = c('LIC', 'LMC', 'UMC'),
  labels = c('Low Income \nCountries', 
             'Low Middle \nIncome \nCountries', 
             'Upper Middle \nIncome \nCountries')
)

unconnected_population_income <-
  ggplot(df,  aes(x = income_group, y = unconnected_pop / 1e9, fill = technology)) +
  geom_bar(stat = 'identity', position = position_dodge(0.9)) + coord_flip() + 
  geom_text(
    aes(label = format(round(after_stat(y), 2), scientific = FALSE)),
    size = 1.8,
    position = position_dodge(0.9),
    vjust = 0.5,
    hjust = -0.3
  ) +
  labs(
    colour = NULL,
    title = '(A) Global Unconnected Population.',
    subtitle = 'By technology and income group.',
    x = NULL,
    y = 'Unconnected Population (in billions)',
    fill = NULL
  ) +
  theme(
    legend.position = 'bottom',
    axis.text.x = element_text(size = 5),
    panel.spacing = unit(0.6, "lines"),
    plot.title = element_text(size = 11),
    plot.subtitle = element_text(size = 10),
    axis.text.y = element_text(size = 7),
    axis.title.y = element_text(size = 7),
    legend.title = element_text(size = 8),
    legend.text = element_text(size = 7),
    axis.title.x = element_text(size = 8)
  ) +
  expand_limits(y = 0) +
  guides(fill = guide_legend(ncol = 5, title = 'Cellphone Technology')) +
  scale_fill_viridis_d(direction = 1) +
  scale_x_discrete(expand = c(0, 0.15)) +
  scale_y_continuous(
    expand = c(0, 0),
    labels = function(y)
      format(y, scientific = FALSE),
    limits = c(0, 1.7)
  ) 


########################################
##Global Unconnected people by regions##
########################################

df = data %>%
  group_by(technology, region) %>%
  summarize(connected_pop = sum(value),
            total_pop = sum(population))

df$unconnected_pop = (df$total_pop - df$connected_pop) 

df$technology = factor(
  df$technology,
  levels = c('GSM', '3G', '4G'),
  labels = c('GSM', '3G', '4G')
)
df$region = factor(
  df$region,
  levels = c('EAP', 'ECA', 'LAC', 'MENA', 'NA', 'SA', 'SSA'),
  labels = c(
    'East Asia \nand Pacific',
    'Europe and \nCentral Asia',
    'Latin \nAmerica and \nthe Caribbean',
    'Middle \nEast and \nNorth Africa',
    'North America',
    'South Asia',
    'Sub-Saharan \nAfrica'
  )
)


unconnected_population_region <-
  ggplot(df,  aes(x = region, y = unconnected_pop / 1e9, fill = technology)) +
  geom_bar(stat = 'identity', position = position_dodge(0.9)) + coord_flip() +
  geom_text(
    aes(label = format(round(after_stat(
      y
    ), 2), scientific = FALSE)),
    size = 1.8,
    position = position_dodge(0.9),
    vjust = 0.5,
    hjust = -0.1
  ) +
  labs(
    colour = NULL,
    title = '(C) Global Unconnected Population.',
    subtitle = 'By technology and region.',
    x = NULL,
    y = 'Unconnected Population (in billions)',
    fill = NULL
  ) +
  theme(
    legend.position = 'bottom',
    axis.text.x = element_text(size = 5),
    panel.spacing = unit(0.6, "lines"),
    plot.title = element_text(size = 11),
    plot.subtitle = element_text(size = 10),
    axis.text.y = element_text(size = 7),
    axis.title.y = element_text(size = 7),
    legend.title = element_text(size = 6),
    legend.text = element_text(size = 5),
    axis.title.x = element_text(size = 8)
  ) +
  expand_limits(y = 0) +
  guides(fill = guide_legend(ncol = 5, title = 'Cellphone Technology')) +
  scale_fill_viridis_d(direction = 1) +
  scale_x_discrete(expand = c(0, 0.15)) +
  scale_y_continuous(
    expand = c(0, 0),
    labels = function(y)
    format(y, scientific = FALSE),
    limits = c(0, 1.33)
  ) 


#############################################
##Relative Unconnected Population by Income##
#############################################
data <- read.csv(file.path(folder, '..', 'data', 'global_results', 'unconnected_global_results.csv'))

country_info = read_csv(file.path(folder, '..', 'data','raw', 'countries.csv'))
data = merge(data, country_info, by = 'iso3')

df = data %>%
  group_by(technology, income) %>%
  summarize(connected_pop = sum(value),
            total_pop = sum(population))

df$unconnected_pop = (df$total_pop - df$connected_pop) 
df$perc = (df$unconnected_pop / df$total_pop) * 100

df$technology = factor(
  df$technology,
  levels = c('GSM', '3G', '4G'),
  labels = c('GSM', '3G', '4G')
)

df$income = factor(
  df$income,
  levels = c('LIC', 'LMC', 'UMC', 'HIC'),
  labels = c('Low Income \nCountries', 
             'Low Middle \nIncome \nCountries', 
             'Upper Middle \nIncome \nCountries',
             'High Income \nCountries')
)

relative_income_unconnected_population <-
  ggplot(df,  aes(x = income, y = perc, fill = technology)) +
  geom_bar(stat = 'identity', position = position_dodge(0.9)) +  coord_flip() +
  geom_text(aes(label = format(round(after_stat(y), 1), scientific = FALSE)),
    size = 1.8,
    position = position_dodge(0.9),
    vjust = 0.5,
    hjust = -0.1
  ) +
  labs(
    colour = NULL,
    title = '(B) Relative Global Unconnected Population.',
    subtitle = 'By technology and income group.',
    x = NULL,
    y = 'Percentage of Population (%)',
    fill = NULL
  ) +
  theme(
    legend.position = 'bottom',
    axis.text.x = element_text(size = 5),
    panel.spacing = unit(0.6, "lines"),
    plot.title = element_text(size = 11),
    plot.subtitle = element_text(size = 10),
    axis.text.y = element_text(size = 7),
    axis.title.y = element_text(size = 7),
    legend.title = element_text(size = 6),
    legend.text = element_text(size = 5),
    axis.title.x = element_text(size = 8)
  ) +
  expand_limits(y = 0) +
  guides(fill = guide_legend(ncol = 5, title = 'Cellphone Technology')) +
  scale_fill_viridis_d(direction = 1) +
  scale_x_discrete(expand = c(0, 0.15)) +
  scale_y_continuous(
    expand = c(0, 0),
    labels = function(y)
      format(y, scientific = FALSE),
    limits = c(0, 100)
  ) 

##############################################
##Relative Unconnected Population by Region ##
##############################################

df = data %>%
  group_by(technology, region) %>%
  summarize(connected_pop = sum(value),
            total_pop = sum(population))

df$unconnected_pop = (df$total_pop - df$connected_pop) 
df$perc = (df$unconnected_pop / df$total_pop) * 100

df$technology = factor(
  df$technology,
  levels = c('GSM', '3G', '4G'),
  labels = c('GSM', '3G', '4G')
)

df$region = factor(
  df$region,
  levels = c('EAP', 'ECA', 'LAC', 'MENA', 'NA', 'SA', 'SSA'),
  labels = c(
    'East Asia \nand Pacific',
    'Europe and \nCentral Asia',
    'Latin \nAmerica and \nthe Caribbean',
    'Middle \nEast and \nNorth Africa',
    'North America',
    'South Asia',
    'Sub-Saharan \nAfrica'
  )
)

relative_region_unconnected_population <-
  ggplot(df,  aes(x = region, y = perc, fill = technology)) +
  geom_bar(stat = 'identity', position = position_dodge(0.9)) +  coord_flip() +
  geom_text(aes(label = format(round(after_stat(y), 1), scientific = FALSE)),
            size = 1.8,
            position = position_dodge(0.9),
            vjust = 0.5,
            hjust = -0.1) +
  labs(
    colour = NULL,
    title = '(D) Relative Global Unconnected Population.',
    subtitle = 'By technology and region.',
    x = NULL,
    y = 'Percentage of Population (%)',
    fill = NULL
  ) +
  theme(
    legend.position = 'bottom',
    axis.text.x = element_text(size = 5),
    panel.spacing = unit(0.6, "lines"),
    plot.title = element_text(size = 11),
    plot.subtitle = element_text(size = 10),
    axis.text.y = element_text(size = 7),
    axis.title.y = element_text(size = 7),
    legend.title = element_text(size = 6),
    legend.text = element_text(size = 5),
    axis.title.x = element_text(size = 8)
  ) +
  expand_limits(y = 0) +
  guides(fill = guide_legend(ncol = 5, title = 'Cellphone Technology')) +
  scale_fill_viridis_d(direction = 1) +
  scale_x_discrete(expand = c(0, 0.15)) +
  scale_y_continuous(
    expand = c(0, 0),
    labels = function(y)
      format(y, scientific = FALSE),
    limits = c(0, 100)
  ) 


##########################################
##PANEL PLOTS FOR UNCONNECTED POPULATION##
##########################################

panel_unconnected_population <- ggarrange(
  unconnected_population_income,
  relative_income_unconnected_population,
  unconnected_population_region,
  relative_region_unconnected_population,
    ncol = 2, nrow = 2, align = c('hv'),
    common.legend = TRUE, legend='bottom',
    heights=c(.6,1))

path = file.path(folder, 'figures', 'a_relative_unconnected_income_region.png')
png(path, units="in", width=8.3, height=8, res=300)
print(panel_unconnected_population)
dev.off()


#############################
##Globally Poor Population ##
#############################

data <- read.csv(file.path(folder, '..', 'data', 'global_results', 'poverty_inline_global_results.csv'))

df = data %>%
  group_by(region, poverty_range) %>%
  summarize(mean = sum(value),
            sd = sd(value))

df$poverty_range = factor(
  df$poverty_range,
  levels = c('< 0', '0 - 0.5', '> 0.5'),
  labels = c('Below 0', '0 - 0.5', 'Above 0.5')
)

df$region = factor(
  df$region,
  levels = c('EAP', 'ECA', 'LAC', 'MENA', 'NA', 'SA', 'SSA'),
  labels = c(
    'East Asia \nand Pacific',
    'Europe and \nCentral Asia',
    'Latin \nAmerica and \nthe Caribbean',
    'Middle \nEast and \nNorth Africa',
    'North America',
    'South Asia',
    'Sub-Saharan \nAfrica'
  )
)

max_y_value = (max(df$mean)) / 1e6

poor_population <-
  ggplot(df,  aes(x = region, y = mean / 1e6, fill = poverty_range)) +
  geom_bar(stat = "identity", position = position_dodge(0.9)) +
  geom_errorbar(
    data = df,
    aes(
      y = mean/1e6,
      ymin = (mean/1e6) - (sd/500),
      ymax = (mean/1e6) + (sd/500)
    ),
    position = position_dodge(0.9),
    lwd = 0.2,
    show.legend = FALSE,
    width = 0.5,
    color = "red"
  ) +
  geom_text(
    aes(label = format(round(after_stat(
      y
    ), 0), scientific = FALSE)),
    size = 1.8,
    position = position_dodge(0.9),
    vjust = 0.5,
    hjust = -1.2,
    angle = 90
  ) +
  labs(
    colour = NULL,
    title = 'Estimated Number of Global Poverty In-line Population',
    subtitle = 'Reported by World Bank Regional Classification and Relative Wealth Index.',
    x = NULL,
    y = 'Poverty In-line \nPopulation (in Millions)',
    fill = NULL
  ) +
  theme(
    legend.position = 'bottom',
    axis.text.x = element_text(hjust = 1, size = 6),
    panel.spacing = unit(0.6, "lines"),
    axis.text.y = element_text(size = 8),
    axis.title.y = element_text(size = 8),
    legend.title = element_text(size = 7),
    legend.text = element_text(size = 7),
    axis.title.x = element_text(size = 9)
  ) +
  expand_limits(y = 0) +
  guides(fill = guide_legend(ncol = 5, 
  title = 'Relative Wealth Index')) +
  scale_fill_viridis_d(direction = 1) +
  scale_x_discrete(expand = c(0, 0.15)) +
  scale_y_continuous(
    expand = c(0, 0),
    labels = function(y)
      format(y, scientific = FALSE),
    limits = c(0, 130)
  ) 


#####################################################
##Global Population Vulnerable to Riverine Flooding##
#####################################################
data <- read.csv(file.path(folder, '..', 'data', 'global_results', 'vulnerable_riverine_population_results.csv'))

df = data %>%
  group_by(region, scenario, period) %>%
  summarize(vulnerable_pop = sum(value_1),
            sd = sd(value_1))

df$period = factor(
  df$period,
  levels = c('rp00100', 'rp01000'),
  labels = c('0.1%', '0.01%')
)
df$scenario = factor(
  df$scenario,
  levels = c('historical', 'rcp4p5', 'rcp8p5'),
  labels = c(
    'Historical (Baseline Condition)',
    'RCP4.5 (2050 Projection)',
    'RCP8.5 (2080 Projection)'
  )
)

riverine_flood_population <-
  ggplot(df,  aes(x = period, y = vulnerable_pop / 1e9, fill = scenario)) +
  geom_bar(stat = "identity", position = position_dodge(0.9)) +
  geom_errorbar(
    data = df,
    aes(
      y = vulnerable_pop,
      ymin = (vulnerable_pop / 1e9) - ((sd/5e9)),
      ymax = (vulnerable_pop / 1e9) + ((sd/5e9))
    ),
    position = position_dodge(0.9),
    lwd = 0.2,
    show.legend = FALSE,
    width = 0.5,
    color = 'red'
  ) +
  geom_text(
    aes(label = format(round(after_stat(
      y
    ), 2), scientific = FALSE)),
    size = 1.8,
    position = position_dodge(0.9),
    vjust = .5,
    hjust = -.7,
    angle = 90
  ) +
  labs(
    colour = NULL,
    title = 'Estimated Number of Vulnerable Global Population to Riverine Flooding',
    subtitle = 'Reported by Climate Scenario, Annual Probability and Regions.',
    x = 'Annual Probability',
    y = 'Population (billions)',
    fill = NULL
  ) +
  theme(
    legend.position = 'bottom',
    axis.text.x = element_text(size = 8),
    panel.spacing = unit(0.6, "lines"),
    axis.text.y = element_text(size = 8),
    axis.title.y = element_text(size = 8),
    axis.title.x = element_text(size = 8)
  ) +
  expand_limits(y = 0) +
  guides(fill = guide_legend(ncol = 6, title = 'Climatic Scenario')) +
  scale_fill_viridis_d(direction = 1) +
  scale_x_discrete(expand = c(0, 0.15)) +
  scale_y_continuous(
    expand = c(0, 0),
    labels = function(y)
      format(y, scientific = FALSE),
    limits = c(0, 1.55)
  ) +
  facet_wrap( ~ region, ncol = 6)


#################################################
##Estimated Global Area Under Riverine Flooding##
#################################################
data <- read.csv(file.path(folder, '..', 'data', 'global_results', 'vulnerable_riverine_area_results.csv'))

df = data %>%
  group_by(region, scenario, period) %>%
  summarize(flooded_area = sum(area),
            sd = sd(area))

df$period = factor(
  df$period,
  levels = c('rp00100', 'rp01000'),
  labels = c('0.1%', '0.01%')
)

df$scenario = factor(
  df$scenario,
  levels = c('historical', 'rcp4p5', 'rcp8p5'),
  labels = c(
    'Historical (Baseline Condition)',
    'RCP4.5 (2050 Projection)',
    'RCP8.5 (2080 Projection)'
  )
)

riverine_flood_area <-
  ggplot(df,  aes(x = period, y = flooded_area / 1e12, fill = scenario)) +
  geom_bar(width = 1, stat = "identity", position = position_dodge(0.9)) +
  geom_errorbar(
    data = df,
    aes(
      y = flooded_area / 1e12,
      ymin = (flooded_area / 1e12) - (sd / 1e12),
      ymax = (flooded_area / 1e12) + (sd / 1e12)
    ),
    position = position_dodge(0.9),
    lwd = 0.2,
    show.legend = FALSE,
    width = 0.5,
    color = 'red'
  ) +
  geom_text(
    aes(label = format(round(after_stat(
      y
    ), 3), scientific = FALSE)),
    size = 1.8,
    position = position_dodge(0.9),
    vjust = .5,
    hjust = -1,
    angle = 90
  ) +
  labs(
    colour = NULL,
    title = 'Estimated Global Area Under Riverine Flooding',
    subtitle = 'Reported by Climate Scenario, Annual Probability and Regions.',
    x = 'Annual Probability',
    y = "Population",
    fill = 'Climatic Scenario'
  ) +  ylab('Flooded Area (millions km<sup>2)') + 
  theme(
    legend.position = 'bottom',
    axis.text.x = element_text(size = 8),
    panel.spacing = unit(0.6, "lines"),
    axis.text.y = element_text(size = 8),
    axis.title.x = element_text(size = 8),
    axis.title.y = element_markdown(size = 8)
  ) +
  expand_limits(y = 0) +
  guides(fill = guide_legend(ncol = 6, title = 'Climatic Scenario')) +
  scale_fill_viridis_d(direction = 1) +
  scale_x_discrete(expand = c(0, 0.15)) +
  scale_y_continuous(
    expand = c(0, 0),
    labels = function(y)
      format(y, scientific = FALSE),
    limits = c(0, 2.2)
  ) + facet_wrap( ~ region, ncol = 6)


#################################
##Riverine Flooding panel plots##
#################################

global_riverine_flooding <- ggarrange(
    riverine_flood_area,
    riverine_flood_population,
    nrow = 2,
    ncol = 1,
    labels = c("A", "B"),
    legend = 'bottom',
    common.legend = TRUE)

path = file.path(folder, 'figures', 'b_global_region_riverine_flooding.png')
dir.create(file.path(folder, 'figures'), showWarnings = FALSE)
png(
  path,
  units = "in",
  width = 8,
  height = 6.5,
  res = 480
)
print(global_riverine_flooding)
dev.off()

####################
##COASTAL FLOODING##
####################


################################################
##Estimated Global Area Under Coastal Flooding##
################################################
data <- read.csv(file.path(folder, '..', 'data', 'global_results', 'vulnerable_coastal_area_results.csv'))

df = data %>%
  group_by(region, scenario, period) %>%
  summarize(flooded_area = sum(area),
            sd = sd(area))

df$period = factor(
  df$period,
  levels = c('rp0100', 'rp1000'),
  labels = c('0.1%', '0.01%')
)

df$scenario = factor(
  df$scenario,
  levels = c('historical', 'rcp4p5', 'rcp8p5'),
  labels = c(
    'Historical \n(Baseline Condition)',
    'RCP4.5 \n(2050 Projection)',
    'RCP8.5 \n(2080 Projection)'
  )
)

coastal_flood_area <-
  ggplot(df,  aes(x = period, y = flooded_area / 1e12, fill = scenario)) +
  geom_bar(width = 1, stat = "identity", position = position_dodge(0.9)) +
  geom_errorbar(
    data = df,
    aes(
      y = flooded_area / 1e12,
      ymin = (flooded_area / 1e12) - (sd / 3e12),
      ymax = (flooded_area / 1e12) + (sd / 3e12)
    ),
    position = position_dodge(0.9),
    lwd = 0.2,
    show.legend = FALSE,
    width = 0.5,
    color = 'red'
  ) +
  geom_text(
    aes(label = format(round(after_stat(
      y
    ), 3), scientific = FALSE)),
    size = 1.8,
    position = position_dodge(0.9),
    vjust = .5,
    hjust = -0.8,
    angle = 90
  ) +
  labs(
    colour = NULL,
    title = 'Estimated Global Area Under Coastal Flooding',
    subtitle = 'Reported by Climate Scenario, Annual Probability and Regions.',
    x = 'Annual Probability',
    y = "Population",
    fill = 'Climatic Scenario'
  ) +  ylab('Flooded Area (millions km<sup>2)') + 
  theme(
    legend.position = 'bottom',
    axis.text.x = element_text(size = 8),
    panel.spacing = unit(0.6, "lines"),
    axis.text.y = element_text(size = 8),
    axis.title.x = element_text(size = 8),
    axis.title.y = element_markdown(size = 8)
  ) +
  expand_limits(y = 0) +
  guides(fill = guide_legend(ncol = 6, title = 'Climatic Scenario')) +
  scale_fill_viridis_d(direction = 1) +
  scale_x_discrete(expand = c(0, 0.15)) +
  scale_y_continuous(
    expand = c(0, 0),
    labels = function(y)
      format(y, scientific = FALSE),
    limits = c(0, 0.13)
  ) + facet_wrap( ~ region, ncol = 6)


####################################################
##Global Population Vulnerable to Coastal Flooding##
####################################################
data <- read.csv(file.path(folder, '..', 'data', 'global_results', 'vulnerable_coastal_population_results.csv'))

df = data %>%
  group_by(region, scenario, period) %>%
  summarize(vulnerable_pop = sum(value_1),
            sd = sd(value_1))

df$period = factor(
  df$period,
  levels = c('rp0100', 'rp1000'),
  labels = c('0.1%', '0.01%')
)
df$scenario = factor(
  df$scenario,
  levels = c('historical', 'rcp4p5', 'rcp8p5'),
  labels = c(
    'Historical \n(Baseline Condition)',
    'RCP4.5 \n(2050 Projection)',
    'RCP8.5 \n(2080 Projection)'
  )
)

coastal_flood_population <-
  ggplot(df,  aes(x = period, y = vulnerable_pop / 1e6, fill = scenario)) +
  geom_bar(stat = "identity", position = position_dodge(0.9)) +
  geom_errorbar(
    data = df,
    aes(
      y = vulnerable_pop,
      ymin = (vulnerable_pop / 1e6) - ((sd / 5e6)),
      ymax = (vulnerable_pop / 1e6) + ((sd / 5e6))
    ),
    position = position_dodge(0.9),
    lwd = 0.2,
    show.legend = FALSE,
    width = 0.5,
    color = 'red'
  ) +
  geom_text(
    aes(label = format(round(after_stat(
      y
    ), 1), scientific = FALSE)),
    size = 1.8,
    position = position_dodge(0.9),
    vjust = .5,
    hjust = -0.9,
    angle = 90
  ) +
  labs(
    colour = NULL,
    title = 'Estimated Number of Vulnerable Global Population to Coastal Flooding',
    subtitle = 'Reported by Climate Scenario, Annual Probability and Regions.',
    x = 'Annual Probability',
    y = 'Population (millions)',
    fill = NULL
  ) +
  theme(
    legend.position = 'bottom',
    axis.text.x = element_text(size = 8),
    panel.spacing = unit(0.6, "lines"),
    axis.text.y = element_text(size = 8),
    axis.title.y = element_text(size = 8),
    axis.title.x = element_text(size = 8)
  ) +
  expand_limits(y = 0) +
  guides(fill = guide_legend(ncol = 6, title = 'Climatic Scenario')) +
  scale_fill_viridis_d(direction = 1) +
  scale_x_discrete(expand = c(0, 0.15)) +
  scale_y_continuous(
    expand = c(0, 0),
    labels = function(y)
      format(y, scientific = FALSE),
    limits = c(0, 260)
  ) +
  facet_wrap( ~ region, ncol = 6)

################################
##Coastal Flooding panel plots##
################################

global_coastal <-
  ggarrange(
    coastal_flood_area,
    coastal_flood_population,
    nrow = 2,
    ncol = 1,
    labels = c("A", "B"),
    legend = 'bottom',
    common.legend = TRUE
    
  )

path = file.path(folder, 'figures', 'c_global_region_coastal_flooding.png')
dir.create(file.path(folder, 'figures'), showWarnings = FALSE)
png(
  path,
  units = "in",
  width = 7,
  height = 6.5,
  res = 480
)
print(global_coastal)
dev.off()

#####################################################
##Relative Riverine Vulnerable Population by Region##
#####################################################
data <- read.csv(file.path(folder, '..', 'data', 'global_results', 'vulnerable_riverine_population_results.csv'))

country_info = read_csv(file.path(folder, '..', 'data','raw', 'countries.csv'))
data = merge(data, country_info, by = 'iso3')

df = data %>%
  group_by(scenario, region) %>%
  summarize(vulnerable_pop = sum(value_1),
            total_pop = sum(population))

df$perc = (df$vulnerable_pop / df$total_pop) * 100

df$scenario = factor(
  df$scenario,
  levels = c('historical', 'rcp4p5', 'rcp8p5'),
  labels = c(
    'Historical (Baseline Condition)',
    'RCP4.5 (2050 Projection)',
    'RCP8.5 (2080 Projection)'
  )
)

df$region = factor(
  df$region,
  levels = c('EAP', 'ECA', 'LAC', 'MENA', 'NA', 'SA', 'SSA'),
  labels = c(
    'East Asia \nand Pacific',
    'Europe and \nCentral Asia',
    'Latin \nAmerica and \nthe Caribbean',
    'Middle \nEast and \nNorth Africa',
    'North America',
    'South Asia',
    'Sub-Saharan \nAfrica'
  )
)

relative_region_vulnerable_riverine_population <-
  ggplot(df,  aes(x = region, y = perc, fill = scenario)) +
  geom_bar(stat = 'identity', position = position_dodge(0.9)) +  coord_flip() +
  geom_text(aes(label = format(round(after_stat(y), 1), scientific = FALSE)),
            size = 1.8,
            position = position_dodge(0.9),
            vjust = 0.5,
            hjust = -0.1
  ) +
  labs(
    colour = NULL,
    title = '(A) Vulnerable Population to Riverine Flooding.',
    subtitle = 'By Climatic Scenario and Region.',
    x = NULL,
    y = 'Percentage of Population (%)',
    fill = NULL
  ) +
  theme(
    legend.position = 'bottom',
    axis.text.x = element_text(size = 5),
    panel.spacing = unit(0.6, "lines"),
    plot.title = element_text(size = 11),
    plot.subtitle = element_text(size = 10),
    axis.text.y = element_text(size = 7),
    axis.title.y = element_text(size = 7),
    legend.title = element_text(size = 6),
    legend.text = element_text(size = 5),
    axis.title.x = element_text(size = 8)
  ) +
  expand_limits(y = 0) +
  guides(fill = guide_legend(ncol = 5, title = 'Climatic Scenario')) +
  scale_fill_viridis_d(direction = 1) +
  scale_x_discrete(expand = c(0, 0.15)) +
  scale_y_continuous(
    expand = c(0, 0),
    labels = function(y)
      format(y, scientific = FALSE),
    limits = c(0, 75)
  ) 

#####################################################
##Relative Coastal Vulnerable Population by Region##
#####################################################
data <- read.csv(file.path(folder, '..', 'data', 'global_results', 'vulnerable_coastal_population_results.csv'))

country_info = read_csv(file.path(folder, '..', 'data','raw', 'countries.csv'))
data = merge(data, country_info, by = 'iso3')

df = data %>%
  group_by(scenario, region) %>%
  summarize(vulnerable_pop = sum(value_1),
            total_pop = sum(population))

df$perc = (df$vulnerable_pop / df$total_pop) * 100

df$scenario = factor(
  df$scenario,
  levels = c('historical', 'rcp4p5', 'rcp8p5'),
  labels = c(
    'Historical (Baseline Condition)',
    'RCP4.5 (2050 Projection)',
    'RCP8.5 (2080 Projection)'
  )
)

df$region = factor(
  df$region,
  levels = c('EAP', 'ECA', 'LAC', 'MENA', 'NA', 'SA', 'SSA'),
  labels = c(
    'East Asia \nand Pacific',
    'Europe and \nCentral Asia',
    'Latin \nAmerica and \nthe Caribbean',
    'Middle \nEast and \nNorth Africa',
    'North America',
    'South Asia',
    'Sub-Saharan \nAfrica'
  )
)

relative_region_vulnerable_coastal_population <-
  ggplot(df,  aes(x = region, y = perc, fill = scenario)) +
  geom_bar(stat = 'identity', position = position_dodge(0.9)) +  coord_flip() +
  geom_text(aes(label = format(round(after_stat(y), 1), scientific = FALSE)),
            size = 1.8,
            position = position_dodge(0.9),
            vjust = 0.5,
            hjust = -0.1
  ) +
  labs(
    colour = NULL,
    title = '(B) Vulnerable Population to Coastal Flooding.',
    subtitle = 'By Climatic Scenario and Region.',
    x = NULL,
    y = 'Percentage of Population (%)',
    fill = NULL
  ) +
  theme(
    legend.position = 'bottom',
    axis.text.x = element_text(size = 5),
    panel.spacing = unit(0.6, "lines"),
    plot.title = element_text(size = 11),
    plot.subtitle = element_text(size = 10),
    axis.text.y = element_text(size = 7),
    axis.title.y = element_text(size = 7),
    legend.title = element_text(size = 6),
    legend.text = element_text(size = 5),
    axis.title.x = element_text(size = 8)
  ) +
  expand_limits(y = 0) +
  guides(fill = guide_legend(ncol = 5, title = 'Climatic Scenario')) +
  scale_fill_viridis_d(direction = 1) +
  scale_x_discrete(expand = c(0, 0.15)) +
  scale_y_continuous(
    expand = c(0, 0),
    labels = function(y)
      format(y, scientific = FALSE),
    limits = c(0, 12)
  ) 

##############################################
##Relative Vulnerable population panel plots##
##############################################

relative_vulnerable_population <-
  ggarrange(
    relative_region_vulnerable_riverine_population,
    relative_region_vulnerable_coastal_population,
    ncol = 2,
    legend = 'bottom',
    common.legend = TRUE
  )

path = file.path(folder, 'figures', 'd_relative_vulnerable_population.png')
dir.create(file.path(folder, 'figures'), showWarnings = FALSE)
png(
  path,
  units = "in",
  width = 8,
  height = 5,
  res = 480
)
print(relative_vulnerable_population)
dev.off()





global_coastal <-
  ggarrange(
    coastal_flood_area,
    coastal_flood_population,
    relative_region_vulnerable_coastal_population,
    nrow = 3,
    legend = 'bottom'
    
  )

path = file.path(folder, 'figures', 'c_global_region_coastal_flooding.png')
dir.create(file.path(folder, 'figures'), showWarnings = FALSE)
png(
  path,
  units = "in",
  width = 7,
  height = 6.5,
  res = 480
)
print(global_coastal)
dev.off()





