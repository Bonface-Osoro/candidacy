library(ggpubr)
library(ggplot2)
library(tidyverse)
library(ggtext)

suppressMessages(library(tidyverse))
folder <- dirname(rstudioapi::getSourceEditorContext()$path)
data <- read.csv(file.path(folder, '..', 'data', 'global_results', 'unconnected_global_results.csv'))

########################################
##Global Unconnected people by regions##
########################################

df = data %>%
  group_by(technology, region) %>%
  summarize(mean = sum(value),
            sd = sd(value))

df$technology = factor(
  df$technology,
  levels = c('GSM', '3G', '4G'),
  labels = c('GSM', '3G', '4G')
)
df$region = factor(
  df$region,
  levels = c('EAP', 'ECA', 'LAC', 'MENA', 'NA', 'SA', 'SSA'),
  labels = c(
    'East Asia \n& Pacific',
    'Europe & \nCentral Asia',
    'Latin America \n& the Caribbean',
    'Middle East \n& North Africa',
    'North America',
    'South Asia',
    'Sub-Saharan \nAfrica'
  )
)

max_y_value = (max(df$mean))/1e9

unconnected_population <-
  ggplot(df,  aes(x = region, y = mean / 1e9, fill = technology)) +
  geom_bar(stat = "identity", position = position_dodge(0.9)) +
  geom_errorbar(
    data = df,
    aes(
      y = mean/1e9,
      ymin = (mean/1e9) - (sd/1e5),
      ymax = (mean/1e9) + (sd/1e5)
    ),
    position = position_dodge(0.9),
    lwd = 0.2,
    show.legend = FALSE,
    width = 0.5,
    color = "red"
  ) +
  geom_text(
    aes(label = format(round(after_stat(
      y
    ), 2), scientific = FALSE)),
    size = 1.8,
    position = position_dodge(0.9),
    vjust = 0.5,
    hjust = -1.5,
    angle = 90
  ) +
  labs(
    colour = NULL,
    title = 'Estimated Number of Unconnected Global Population to Cellphone Service.',
    subtitle = "Reported by World Bank Regional Classification and Type of Cellular Technology.",
    x = NULL,
    y = 'Unconnected \nPopulation (in billions)',
    fill = NULL
  ) +
  theme(
    legend.position = 'bottom',
    axis.text.x = element_text(hjust = 1, size = 6),
    panel.spacing = unit(0.6, "lines"),
    axis.text.y = element_text(size = 8),
    axis.title.y = element_text(size = 8),
    legend.title = element_text(size = 7),
    legend.text = element_text(size = 6),
    axis.title.x = element_text(size = 9)
  ) +
  expand_limits(y = 0) +
  guides(fill = guide_legend(ncol = 5, title = 'Cellphone Technology')) +
  scale_fill_viridis_d(direction = 1) +
  scale_x_discrete(expand = c(0, 0.15)) +
  scale_y_continuous(
    expand = c(0, 0),
    labels = function(y)
    format(y, scientific = FALSE),
    limits = c(0, 2.1)
  ) 

##################################################
##Global Unconnected people by region dodged bar##
##################################################

df = data %>%
  group_by(technology, region) %>%
  summarize(mean = sum(value),
            sd = sd(value))

df$technology = factor(
  df$technology,
  levels = c('GSM', '3G', '4G'),
  labels = c('GSM', '3G', '4G')
)

df$region = factor(
  df$region,
  levels = c('EAP', 'ECA', 'LAC', 'MENA', 'NA', 'SA', 'SSA'),
  labels = c(
    'East Asia and Pacific',
    'Europe and Central Asia',
    'Latin America and the Caribbean',
    'Middle East and North Africa',
    'North America',
    'South Asia',
    'Sub-Saharan Africa'
  )
)

max_y_value = (max(df$mean))/1e9

unconnected_population_region_dodged <-
  ggplot(df,  aes(x = region, y = mean / 1e9, fill = technology, group = technology)) +
  geom_bar(stat = "identity") +  coord_flip() +
  geom_text(aes(label = paste(round(after_stat(y), 2)), group = region),
            stat = 'summary', fun = sum, hjust = -.2, size=2.5) +
  labs(
    colour = NULL,
    title = '(A) Estimated Number of Unconnected Global Population to Cellphone Service.',
    subtitle = "Reported by World Bank Regional Classification and Type of Cellular Technology.",
    x = NULL,
    y = 'Unconnected Population (in billions)',
    fill = NULL
  ) +
  theme(
    legend.position = 'bottom',
    axis.text.x = element_text(hjust = 1, size = 6),
    panel.spacing = unit(0.6, "lines"),
    axis.text.y = element_text(size = 8),
    axis.title.y = element_text(size = 8),
    legend.title = element_text(size = 7),
    legend.text = element_text(size = 6),
    axis.title.x = element_text(size = 9)
  ) +
  expand_limits(y = 0) +
  guides(fill = guide_legend(ncol = 5, title = 'Cellphone Technology')) +
  scale_fill_viridis_d(direction = 1) +
  scale_x_discrete(expand = c(0, 0.15)) +
  scale_y_continuous(
    expand = c(0, 0),
    labels = function(y)
      format(y, scientific = FALSE),
    limits = c(0, 3.8)
  ) 


#############################################
##Global Unconnected people by income group##
#############################################

df = data %>%
  group_by(technology, income) %>%
  summarize(mean = sum(value),
            sd = sd(value))

df$technology = factor(
  df$technology,
  levels = c('GSM', '3G', '4G'),
  labels = c('GSM', '3G', '4G')
)

df$income = factor(
  df$income,
  levels = c('LIC', 'LMC', 'UMC', 'HIC'),
  labels = c('Low Income Countries', 
             'Low Middle Income Countries', 
             'Upper Middle Income Countries',
             'High Income Countries')
)

max_y_value = (max(df$mean))/1e9

unconnected_population_income <-
  ggplot(df,  aes(x = income, y = mean / 1e9, fill = technology, group = technology)) +
  geom_bar(stat = "identity") +  coord_flip() +
  geom_text(aes(label = paste(round(after_stat(y), 2)), group = income),
            stat = 'summary', fun = sum, hjust = -.2, size=2.5) +
  labs(
    colour = NULL,
    title = '(B) Estimated Number of Unconnected Global Population to Cellphone Service.',
    subtitle = "Reported by World Bank Income Group Classification and Type of Cellular Technology.",
    x = NULL,
    y = 'Unconnected Population (in billions)',
    fill = NULL
  ) +
  theme(
    legend.position = 'bottom',
    axis.text.x = element_text(hjust = 1, size = 6),
    panel.spacing = unit(0.6, "lines"),
    axis.text.y = element_text(size = 8),
    axis.title.y = element_text(size = 8),
    legend.title = element_text(size = 7),
    legend.text = element_text(size = 6),
    axis.title.x = element_text(size = 9)
  ) +
  expand_limits(y = 0) +
  guides(fill = guide_legend(ncol = 5, title = 'Cellphone Technology')) +
  scale_fill_viridis_d(direction = 1) +
  scale_x_discrete(expand = c(0, 0.15)) +
  scale_y_continuous(
    expand = c(0, 0),
    labels = function(y)
      format(y, scientific = FALSE),
    limits = c(0, 6)
  ) 

######################################################
##Absolute Unconnected Population Dodged Panel Plots##
#####################################################

dodged_absolute_plots <- ggarrange(unconnected_population_region_dodged, 
    unconnected_population_income,
    ncol = 1, nrow = 2, align = c("hv"),
    common.legend = TRUE, legend='bottom',
    heights=c(.99,1))

path = file.path(folder, 'figures', 'absolute_unconnected.tiff')
tiff(path, units="in", width=8.3, height=6, res=300)
print(dodged_absolute_plots)
dev.off()


#############################
##Globally Poor Population ##
#############################

data <- read.csv(file.path(folder, '..', 'data', 'global_results', 'poverty_inline_global_results.csv'))

df = data %>%
  group_by(region, poverty_range) %>%
  summarize(mean = sum(value),
            sd = sd(value))

df$poverty_range = factor(
  df$poverty_range,
  levels = c('< 0', '0 - 0.5', '> 0.5'),
  labels = c('Below 0', '0 - 0.5', 'Above 0.5')
)

df$region = factor(
  df$region,
  levels = c('EAP', 'ECA', 'LAC', 'MENA', 'NA', 'SA', 'SSA'),
  labels = c(
    'East Asia \n& Pacific',
    'Europe & \nCentral Asia',
    'Latin America \n& the Caribbean',
    'Middle East \n& North Africa',
    'North America',
    'South Asia',
    'Sub-Saharan \nAfrica'
  )
)

max_y_value = (max(df$mean)) / 1e6

poor_population <-
  ggplot(df,  aes(x = region, y = mean / 1e6, fill = poverty_range)) +
  geom_bar(stat = "identity", position = position_dodge(0.9)) +
  geom_errorbar(
    data = df,
    aes(
      y = mean/1e6,
      ymin = (mean/1e6) - (sd/500),
      ymax = (mean/1e6) + (sd/500)
    ),
    position = position_dodge(0.9),
    lwd = 0.2,
    show.legend = FALSE,
    width = 0.5,
    color = "red"
  ) +
  geom_text(
    aes(label = format(round(after_stat(
      y
    ), 0), scientific = FALSE)),
    size = 1.8,
    position = position_dodge(0.9),
    vjust = 0.5,
    hjust = -1.2,
    angle = 90
  ) +
  labs(
    colour = NULL,
    title = 'Estimated Number of Global Poverty In-line Population',
    subtitle = "Reported by World Bank Regional Classification and Relative Wealth Index.",
    x = NULL,
    y = 'Poverty In-line \nPopulation (in Millions)',
    fill = NULL
  ) +
  theme(
    legend.position = 'bottom',
    axis.text.x = element_text(hjust = 1, size = 6),
    panel.spacing = unit(0.6, "lines"),
    axis.text.y = element_text(size = 8),
    axis.title.y = element_text(size = 8),
    legend.title = element_text(size = 7),
    legend.text = element_text(size = 7),
    axis.title.x = element_text(size = 9)
  ) +
  expand_limits(y = 0) +
  guides(fill = guide_legend(ncol = 5, 
  title = 'Relative Wealth Index')) +
  scale_fill_viridis_d(direction = 1) +
  scale_x_discrete(expand = c(0, 0.15)) +
  scale_y_continuous(
    expand = c(0, 0),
    labels = function(y)
      format(y, scientific = FALSE),
    limits = c(0, 130)
  ) 

########################################
##Connectivity and Poverty panel plots##
########################################

connectivity_poverty <-
  ggarrange(
    unconnected_population,
    poor_population,
    nrow = 2,
    ncol = 1,
    labels = c("A", "B"),
    legend = 'bottom'
    
  )

path = file.path(folder, 'figures', 'unconnected_poverty.png')
dir.create(file.path(folder, 'figures'), showWarnings = FALSE)
png(
  path,
  units = "in",
  width = 6.7,
  height = 7.5,
  res = 480
)
print(connectivity_poverty)
dev.off()

#####################################################
##Global Population Vulnerable to Riverine Flooding##
#####################################################
data <- read.csv(file.path(folder, '..', 'data', 'global_results', "riverine_population_results.csv"))

df = data %>%
  group_by(continent, scenario, period) %>%
  summarize(mean = sum(value_1),
            sd = sd(value_1))

df$period = factor(
  df$period,
  levels = c('rp00100', 'rp01000'),
  labels = c('0.1%', '0.01%')
)
df$scenario = factor(
  df$scenario,
  levels = c('historical', 'rcp4p5', 'rcp8p5'),
  labels = c(
    'Historical (Baseline Condition)',
    'RCP4.5 (2050 Projection)',
    'RCP8.5 (2080 Projection)'
  )
)

max_y_value = max(df$mean)

riverine_flood_population <-
  ggplot(df,  aes(x = period, y = mean, fill = continent)) +
  geom_bar(stat = "identity", position = position_dodge(0.9)) +
  geom_errorbar(
    data = df,
    aes(
      y = mean,
      ymin = mean - (sd/0.3),
      ymax = mean + (sd/0.3)
    ),
    position = position_dodge(0.9),
    lwd = 0.2,
    show.legend = FALSE,
    width = 0.5,
    color = "red"
  ) +
  geom_text(
    aes(label = format(round(after_stat(
      y
    ), 0), scientific = FALSE)),
    size = 1.8,
    position = position_dodge(0.9),
    vjust = .5,
    hjust = -.43,
    angle = 90
  ) +
  labs(
    colour = NULL,
    title = "Estimated Number of Vulnerable Global Population to Riverine Flooding",
    subtitle = "Reported by Climate Scenario, Annual Probability and Continents.",
    x = 'Annual Probability',
    y = "Population",
    fill = NULL
  ) +
  theme(
    legend.position = 'bottom',
    axis.text.x = element_text(hjust = 1, size = 8),
    panel.spacing = unit(0.6, "lines"),
    axis.text.y = element_text(size = 8),
    axis.title.y = element_text(size = 8),
    axis.title.x = element_text(size = 8)
  ) +
  expand_limits(y = 0) +
  guides(fill = guide_legend(ncol = 5, title = 'Continents')) +
  scale_fill_viridis_d(direction = 1) +
  scale_x_discrete(expand = c(0, 0.15)) +
  scale_y_continuous(
    expand = c(0, 0),
    labels = function(y)
      format(y, scientific = FALSE),
    limits = c(0, 57000)
  ) +
  facet_wrap( ~ scenario)


#################################################
##Estimated Global Area Under Riverine Flooding##
#################################################
data <- read.csv(file.path(folder, '..', 'data', 'global_results', 'riverine_area_results.csv'))

df = data %>%
  group_by(continent, scenario, period) %>%
  summarize(mean = mean(area) / 1e6,
            sd = sd(area))

df$period = factor(
  df$period,
  levels = c('rp00100', 'rp01000'),
  labels = c('0.1%', '0.01%')
)
df$scenario = factor(
  df$scenario,
  levels = c('historical', 'rcp4p5', 'rcp8p5'),
  labels = c(
    'Historical (Baseline Condition)',
    'RCP4.5 (2050 Projection)',
    'RCP8.5 (2080 Projection)'
  )
)

max_y_value = max(df$mean)

riverine_flood_area <-
  ggplot(df,  aes(x = period, y = mean, fill = continent)) +
  geom_bar(width = 1, stat = "identity", position = position_dodge(0.9)) +
  geom_errorbar(
    data = df,
    aes(
      y = mean,
      ymin = mean - (sd/1e6),
      ymax = mean + (sd/1e6)
    ),
    position = position_dodge(0.9),
    lwd = 0.2,
    show.legend = FALSE,
    width = 0.5,
    color = "red"
  ) +
  geom_text(
    aes(label = format(round(after_stat(
      y
    ), 3), scientific = FALSE)),
    size = 1.8,
    position = position_dodge(0.9),
    vjust = .5,
    hjust = - 1.9,
    angle = 90
  ) +
  labs(
    colour = NULL,
    title = "Estimated Global Area Under Riverine Flooding",
    subtitle = "Reported by Climate Scenario, Annual Probability and Continents.",
    x = 'Annual Probability',
    y = "Population",
    fill = NULL
  ) +  ylab("Flooded Area (Millions km<sup>2)") + 
  theme(
    legend.position = 'bottom',
    axis.text.x = element_text(hjust = 1, size = 8),
    panel.spacing = unit(0.6, "lines"),
    axis.text.y = element_text(size = 8),
    axis.title.x = element_text(size = 8),
    axis.title.y = element_markdown(size = 8)
  ) +
  expand_limits(y = 0) +
  guides(fill = guide_legend(ncol = 5, title = 'Continents')) +
  scale_fill_viridis_d(direction = 1) +
  scale_x_discrete(expand = c(0, 0.15)) +
  scale_y_continuous(
    expand = c(0, 0),
    labels = function(y)
      format(y, scientific = FALSE),
    limits = c(0, 0.53)
  ) +
  facet_wrap( ~ scenario)


####################
##COASTAL FLOODING##
####################


################################################
##Estimated Global Area Under Coastal Flooding##
################################################
data <- read.csv(file.path(folder, '..', 'data', 'global_results', 'coastal_area_results.csv'))

df = data %>%
  group_by(continent, scenario, period) %>%
  summarize(mean = mean(area)/1e6,
            sd = sd(area))

df$period = factor(
  df$period,
  levels = c('rp0100', 'rp1000'),
  labels = c('0.1%', '0.01%')
)
df$scenario = factor(
  df$scenario,
  levels = c('historical', 'rcp4p5', 'rcp8p5'),
  labels = c(
    'Historical (Baseline Condition)',
    'RCP4.5 (2050 Projection)',
    'RCP8.5 (2080 Projection)'
  )
)

max_y_value = max(df$mean)

coastal_flood_area <-
  ggplot(df,  aes(x = period, y = mean, fill = continent)) +
  geom_bar(width = 1, stat = "identity", position = position_dodge(0.95)) +
  geom_errorbar(
    data = df,
    aes(
      y = mean,
      ymin = mean - (sd/1e7),
      ymax = mean + (sd/1e7)
    ),
    position = position_dodge(0.95),
    lwd = 0.2,
    show.legend = FALSE,
    width = 0.5,
    color = "red"
  ) +
  geom_text(
    aes(label = format(round(after_stat(
      y
    ), 3), scientific = FALSE)),
    size = 1.8,
    position = position_dodge(0.95),
    vjust = .5,
    hjust = - 0.5,
    angle = 90
  ) +
  labs(
    colour = NULL,
    title = "Estimated Global Area Under Coastal Flooding",
    subtitle = "Reported by Climate Scenario, Annual Probability and Continents.",
    x = 'Annual Probability',
    y = "Population",
    fill = NULL
  ) +  ylab("Flooded Area (Millions km<sup>2)") + 
  theme(
    legend.position = 'bottom',
    axis.text.x = element_text(hjust = 1, size = 8),
    panel.spacing = unit(0.6, "lines"),
    axis.text.y = element_text(size = 8),
    axis.title.x = element_text(size = 8),
    axis.title.y = element_markdown(size = 8)
  ) +
  expand_limits(y = 0) +
  guides(fill = guide_legend(ncol = 5, title = 'Continents')) +
  scale_fill_viridis_d(direction = 1) +
  scale_x_discrete(expand = c(0, 0.15)) +
  scale_y_continuous(
    expand = c(0, 0),
    labels = function(y)
      format(y, scientific = FALSE),
    limits = c(0, 0.26)
  ) +
  facet_wrap( ~ scenario)


####################################################
##Global Population Vulnerable to Coastal Flooding##
####################################################
data <- read.csv(file.path(folder, '..', 'data', 'global_results', "coastal_population_results.csv"))

df = data %>%
  group_by(continent, scenario, period) %>%
  summarize(mean = sum(value_1),
            sd = sd(value_1))

df$period = factor(
  df$period,
  levels = c('rp0100', 'rp1000'),
  labels = c('0.1%', '0.01%')
)
df$scenario = factor(
  df$scenario,
  levels = c('historical', 'rcp4p5', 'rcp8p5'),
  labels = c(
    'Historical (Baseline Condition)',
    'RCP4.5 (2050 Projection)',
    'RCP8.5 (2080 Projection)'
  )
)

max_y_value = max(df$mean)

coastal_flood_population <-
  ggplot(df,  aes(x = period, y = mean, fill = continent)) +
  geom_bar(width = 1, stat = "identity", position = position_dodge(0.9)) +
  geom_errorbar(
    data = df,
    aes(
      y = mean,
      ymin = mean - (sd/0.3),
      ymax = mean + (sd/0.3)
    ),
    position = position_dodge(0.9),
    lwd = 0.2,
    show.legend = FALSE,
    width = 0.5,
    color = "red"
  ) +
  geom_text(
    aes(label = format(round(after_stat(
      y
    ), 0), scientific = FALSE)),
    size = 1.8,
    position = position_dodge(0.9),
    vjust = .5,
    hjust = -1.2,
    angle = 90
  ) +
  labs(
    colour = NULL,
    title = "Estimated Number of Vulnerable Global Population to Coastal Flooding",
    subtitle = "Reported by Climate Scenario, Annual Probability and Continents.",
    x = 'Annual Probability',
    y = "Population",
    fill = NULL
  ) +
  theme(
    legend.position = 'bottom',
    axis.text.x = element_text(hjust = 1, size = 8),
    panel.spacing = unit(0.6, "lines"),
    axis.text.y = element_text(size = 8),
    axis.title.y = element_text(size = 8),
    axis.title.x = element_text(size = 8)
  ) +
  expand_limits(y = 0) +
  guides(fill = guide_legend(ncol = 5, title = 'Continents')) +
  scale_fill_viridis_d(direction = 1) +
  scale_x_discrete(expand = c(0, 0.15)) +
  scale_y_continuous(
    expand = c(0, 0),
    labels = function(y)
      format(y, scientific = FALSE),
    limits = c(0, 49000)
  ) +
  facet_wrap( ~ scenario)


###############
##PANEL PLOTS##
###############

############################
##Connectivity panel plots##
############################

global_connectivity <-
  ggarrange(
    unconnected_river_population,
    unconnected_coast_population,
    nrow = 2,
    ncol = 1,
    labels = c("A", "B"),
    common.legend = TRUE,
    legend = 'bottom'
  )

path = file.path(folder, 'figures', 'global_connectivity.png')
dir.create(file.path(folder, 'figures'), showWarnings = FALSE)
png(
  path,
  units = "in",
  width = 9,
  height = 7.5,
  res = 480
)
print(global_connectivity)
dev.off()


#################################
##Riverine Flooding panel plots##
#################################

global_riverine_flooding <-
  ggarrange(
    riverine_flood_area,
    riverine_flood_population,
    nrow = 2,
    ncol = 1,
    labels = c("A", "B"),
    legend = 'bottom',
    common.legend = TRUE
    
  )

path = file.path(folder, 'figures', 'global_riverine_flooding.png')
dir.create(file.path(folder, 'figures'), showWarnings = FALSE)
png(
  path,
  units = "in",
  width = 7,
  height = 7.5,
  res = 480
)
print(global_riverine_flooding)
dev.off()


################################
##Coastal Flooding panel plots##
################################

global_coastal <-
  ggarrange(
    coastal_flood_area,
    coastal_flood_population,
    nrow = 2,
    ncol = 1,
    labels = c("A", "B"),
    legend = 'bottom',
    common.legend = TRUE
    
  )

path = file.path(folder, 'figures', 'global_coastal_flooding.png')
dir.create(file.path(folder, 'figures'), showWarnings = FALSE)
png(
  path,
  units = "in",
  width = 7,
  height = 7.5,
  res = 480
)
print(global_coastal)
dev.off()


